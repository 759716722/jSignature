// -- Sammy.js -- /sammy.js
// http://sammyjs.org
// Version: 0.6.3
// Built: 2011-01-27 10:31:14 -0800
// -- Sammy.js -- /plugins/sammy.googleanalytics.js
// http://sammyjs.org
// Version: 0.6.3
// Built: 2011-01-27 10:31:04 -0800
// Sammy.js custom build 2012-05-21. https://github.com/willowsystems/sammy
(function(c,f){var e,n=/:([\w\d]+)/g,l=/\?([^#]*)$/,m=function(a){return Array.prototype.slice.call(a)},g=function(a){return"[object Function]"===Object.prototype.toString.call(a)},h=function(a){return"[object Array]"===Object.prototype.toString.call(a)},k=function(a){return decodeURIComponent(a.replace(/\+/g," "))},p=encodeURIComponent,j=function(a){return(""+a).replace(/&(?!\w+;)/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;")},o=function(a){return function(b,d){return this.route.apply(this,
[a,b,d])}},q={},r=[];e=function(){var a=m(arguments),b,d;e.apps=e.apps||{};if(0===a.length||a[0]&&g(a[0]))return e.apply(e,["body"].concat(a));if("string"==typeof(d=a.shift()))return b=e.apps[d]||new e.Application,b.element_selector=d,0<a.length&&c.each(a,function(a,d){b.use(d)}),b.element_selector!=d&&delete e.apps[d],e.apps[b.element_selector]=b};e.VERSION="0.6.3";e.addLogger=function(a){r.push(a)};e.log=function(){var a=m(arguments);a.unshift("["+Date()+"]");c.each(r,function(b,d){d.apply(e,a)})};
"undefined"!=typeof f.console?g(f.console.log.apply)?e.addLogger(function(){f.console.log.apply(f.console,arguments)}):e.addLogger(function(){f.console.log(arguments)}):"undefined"!=typeof console&&e.addLogger(function(){console.log.apply(console,arguments)});c.extend(e,{makeArray:m,isFunction:g,isArray:h});e.Object=function(a){return c.extend(this,a||{})};c.extend(e.Object.prototype,{escapeHTML:j,h:j,toHash:function(){var a={};c.each(this,function(b,d){g(d)||(a[b]=d)});return a},toHTML:function(){var a=
"";c.each(this,function(b,d){g(d)||(a+="<strong>"+b+"</strong> "+d+"<br />")});return a},keys:function(a){var b=[],d;for(d in this)(!g(this[d])||!a)&&b.push(d);return b},has:function(a){return this[a]&&""!=c.trim(this[a].toString())},join:function(){var a=m(arguments),b=a.shift();return a.join(b)},log:function(){e.log.apply(e,arguments)},toString:function(a){var b=[];c.each(this,function(d,i){(!g(i)||a)&&b.push('"'+d+'": '+i.toString())});return"Sammy.Object: {"+b.join(",")+"}"}});e.HashLocationProxy=
function(a,b){this.app=a;this.is_native=!1;this._startPolling(b)};e.HashLocationProxy.prototype={bind:function(){var a=this,b=this.app;c(f).bind("hashchange."+this.app.eventNamespace(),function(d,i){!1===a.is_native&&!i&&(e.log("native hash change exists, using"),a.is_native=!0,f.clearInterval(e.HashLocationProxy._interval));b.trigger("location-changed")});e.HashLocationProxy._bindings||(e.HashLocationProxy._bindings=0);e.HashLocationProxy._bindings++},unbind:function(){c(f).unbind("hashchange."+
this.app.eventNamespace());e.HashLocationProxy._bindings--;0>=e.HashLocationProxy._bindings&&f.clearInterval(e.HashLocationProxy._interval)},getLocation:function(){var a=f.location.toString().match(/^[^#]*(#.+)$/);return a?a[1]:""},setLocation:function(a){return f.location=a},_startPolling:function(a){var b=this;if(!e.HashLocationProxy._interval){a||(a=10);var d=function(){var a=b.getLocation();(!e.HashLocationProxy._last_location||a!=e.HashLocationProxy._last_location)&&f.setTimeout(function(){c(f).trigger("hashchange",
[!0])},13);e.HashLocationProxy._last_location=a};d();e.HashLocationProxy._interval=f.setInterval(d,a)}}};e.Application=function(a){var b=this;this.routes={};this.listeners=new e.Object({});this.arounds=[];this.befores=[];this.namespace=(new Date).getTime()+"-"+parseInt(1E3*Math.random(),10);this.context_prototype=function(){e.EventContext.apply(this,arguments)};this.context_prototype.prototype=new e.EventContext;g(a)&&a.apply(this,[this]);this._location_proxy||this.setLocationProxy(new e.HashLocationProxy(this,
this.run_interval_every));this.debug&&this.bindToAllEvents(function(a,i){b.log(b.toString(),a.cleaned_type,i||{})})};e.Application.prototype=c.extend({},e.Object.prototype,{ROUTE_VERBS:["get","post","put","delete"],APP_EVENTS:"run,unload,lookup-route,run-route,route-found,event-context-before,event-context-after,changed,error,check-form-submission,redirect,location-changed".split(","),_last_route:null,_location_proxy:null,_running:!1,element_selector:"body",debug:!1,raise_errors:!1,run_interval_every:50,
template_engine:null,toString:function(){return"Sammy.Application:"+this.element_selector},$element:function(a){return a?c(this.element_selector).find(a):c(this.element_selector)},use:function(){var a=m(arguments),b=a.shift(),d=b||"";try{a.unshift(this),"string"==typeof b&&(d="Sammy."+b,b=e[b]),b.apply(this,a)}catch(i){"undefined"===typeof b?this.error("Plugin Error: called use() but plugin ("+d.toString()+") is not defined",i):g(b)?this.error("Plugin Error",i):this.error("Plugin Error: called use() but '"+
d.toString()+"' is not a function",i)}return this},setLocationProxy:function(a){var b=this._location_proxy;this._location_proxy=a;this.isRunning()&&(b&&b.unbind(),this._location_proxy.bind())},route:function(a,b,d){var i=this,e=[],h,k;!d&&g(b)&&(d=b=a,a="any");a=a.toLowerCase();if(b.constructor==String){for(n.lastIndex=0;null!==(k=n.exec(b));)e.push(k[1]);b=RegExp("^"+b.replace(n,"([^/]+)")+"$")}"string"==typeof d&&(d=i[d]);h=function(a){var c={verb:a,path:b,callback:d,param_names:e};i.routes[a]=
i.routes[a]||[];i.routes[a].push(c)};"any"===a?c.each(this.ROUTE_VERBS,function(a,b){h(b)}):h(a);return this},get:o("get"),post:o("post"),put:o("put"),del:o("delete"),any:o("any"),mapRoutes:function(a){var b=this;c.each(a,function(a,i){b.route.apply(b,i)});return this},eventNamespace:function(){return["sammy-app",this.namespace].join("-")},bind:function(a,b,d){var i=this;"undefined"==typeof d&&(d=b);b=function(a,b){var c;b&&b.context?(c=b.context,delete b.context):c=new i.context_prototype(i,"bind",
a.type,b,a.target);a.cleaned_type=a.type.replace(i.eventNamespace(),"");d.apply(c,[a,b])};this.listeners[a]||(this.listeners[a]=[]);this.listeners[a].push(b);this.isRunning()&&this._listen(a,b);return this},trigger:function(a,b){this.$element().trigger([a,this.eventNamespace()].join("."),[b]);return this},refresh:function(){this.last_location=null;this.trigger("location-changed");return this},before:function(a,b){g(a)&&(b=a,a={});this.befores.push([a,b]);return this},after:function(a){return this.bind("event-context-after",
a)},around:function(a){this.arounds.push(a);return this},isRunning:function(){return this._running},helpers:function(a){c.extend(this.context_prototype.prototype,a);return this},helper:function(a,b){this.context_prototype.prototype[a]=b;return this},run:function(a){if(this.isRunning())return!1;var b=this;c.each(this.listeners.toHash(),function(a,i){c.each(i,function(i,c){b._listen(a,c)})});this.trigger("run",{start_url:a});this._running=!0;this.last_location=null;""==this.getLocation()&&"undefined"!=
typeof a&&this.setLocation(a);this._checkLocation();this._location_proxy.bind();this.bind("location-changed",function(){b._checkLocation()});this.bind("submit",function(a){return!1===b._checkFormSubmission(c(a.target).closest("form"))?a.preventDefault():!1});c(f).bind("beforeunload",function(){b.unload()});return this.trigger("changed")},unload:function(){if(!this.isRunning())return!1;var a=this;this.trigger("unload");this._location_proxy.unbind();this.$element().unbind("submit").removeClass(a.eventNamespace());
c.each(this.listeners.toHash(),function(b,d){c.each(d,function(d,c){a._unlisten(b,c)})});this._running=!1;return this},bindToAllEvents:function(a){var b=this;c.each(this.APP_EVENTS,function(d,c){b.bind(c,a)});c.each(this.listeners.keys(!0),function(d,c){-1==b.APP_EVENTS.indexOf(c)&&b.bind(c,a)});return this},routablePath:function(a){return a.replace(l,"")},lookupRoute:function(a,b){var d=this,i=!1;this.trigger("lookup-route",{verb:a,path:b});"undefined"!=typeof this.routes[a]&&c.each(this.routes[a],
function(a,c){if(d.routablePath(b).match(c.path))return i=c,!1});return i},runRoute:function(a,b,d,i){var e=this,h=this.lookupRoute(a,b),g,f,j,p,o,l,m;this.log("runRoute",[a,b].join(" "));this.trigger("run-route",{verb:a,path:b,params:d});"undefined"==typeof d&&(d={});c.extend(d,this._parseQueryString(b));if(h){this.trigger("route-found",{route:h});if(null!==(l=h.path.exec(this.routablePath(b))))l.shift(),c.each(l,function(a,b){h.param_names[a]?d[h.param_names[a]]=k(b):(d.splat||(d.splat=[]),d.splat.push(k(b)))});
g=new this.context_prototype(this,a,b,d,i);i=this.arounds.slice(0);j=this.befores.slice(0);o=[g].concat(d.splat);f=function(){for(var a;0<j.length;)if(p=j.shift(),e.contextMatchesOptions(g,p[0])&&(a=p[1].apply(g,[g]),!1===a))return!1;e.last_route=h;g.trigger("event-context-before",{context:g});a=h.callback.apply(g,o);g.trigger("event-context-after",{context:g});return a};c.each(i.reverse(),function(a,b){var d=f;f=function(){return b.apply(g,[d])}});try{m=f()}catch(n){this.error(["500 Error",a,b].join(" "),
n)}return m}return this.notFound(a,b)},contextMatchesOptions:function(a,b,d){if("undefined"===typeof b||b=={})return!0;"undefined"===typeof d&&(d=!0);if("string"===typeof b||g(b.test))b={path:b};if(b.only)return this.contextMatchesOptions(a,b.only,!0);if(b.except)return this.contextMatchesOptions(a,b.except,!1);var c=!0,e=!0;b.path&&(c=g(b.path.test)?b.path.test(a.path):b.path.toString()===a.path);b.verb&&(e=b.verb===a.verb);return d?e&&c:!(e&&c)},getLocation:function(){return this._location_proxy.getLocation()},
setLocation:function(a){return this._location_proxy.setLocation(a)},swap:function(a){return this.$element().html(a)},templateCache:function(a,b){return"undefined"!=typeof b?q[a]=b:q[a]},clearTemplateCache:function(){return q={}},notFound:function(a,b){var d=this.error(["404 Not Found",a,b].join(" "));return"get"===a?d:!0},error:function(a,b){b||(b=Error());b.message=[a,b.message].join(" ");this.trigger("error",{message:b.message,error:b});if(this.raise_errors)throw b;this.log(b.message,b)},_checkLocation:function(){var a,
b;a=this.getLocation();if(!this.last_location||"get"!=this.last_location[0]||this.last_location[1]!=a)this.last_location=["get",a],b=this.runRoute("get",a);return b},_getFormVerb:function(a){var a=c(a),b,d;d=a.find('input[name="_method"]');0<d.length&&(b=d.val());b||(b=a[0].getAttribute("method"));if(!b||""==b)b="get";return c.trim(b.toString().toLowerCase())},_checkFormSubmission:function(a){var b,d,e;this.trigger("check-form-submission",{form:a});b=c(a);d=b.attr("action");e=this._getFormVerb(b);
this.log("_checkFormSubmission",b,d,e);"get"===e?(this.setLocation(d+"?"+this._serializeFormParams(b)),a=!1):(b=c.extend({},this._parseFormParams(b)),a=this.runRoute(e,d,b,a.get(0)));return"undefined"==typeof a?!1:a},_serializeFormParams:function(a){var b="",a=a.serializeArray(),d;if(0<a.length){b=this._encodeFormPair(a[0].name,a[0].value);for(d=1;d<a.length;d++)b=b+"&"+this._encodeFormPair(a[d].name,a[d].value)}return b},_encodeFormPair:function(a,b){return p(a)+"="+p(b)},_parseFormParams:function(a){var b=
{},a=a.serializeArray(),d;for(d=0;d<a.length;d++)b=this._parseParamPair(b,a[d].name,a[d].value);return b},_parseQueryString:function(a){var b={},d,c;if(a=a.match(l)){a=a[1].split("&");for(c=0;c<a.length;c++)d=a[c].split("="),b=this._parseParamPair(b,k(d[0]),k(d[1]))}return b},_parseParamPair:function(a,b,d){a[b]?h(a[b])?a[b].push(d):a[b]=[a[b],d]:a[b]=d;return a},_listen:function(a,b){return this.$element().bind([a,this.eventNamespace()].join("."),b)},_unlisten:function(a,b){return this.$element().unbind([a,
this.eventNamespace()].join("."),b)}});e.RenderContext=function(a){this.event_context=a;this.callbacks=[];this.content=this.previous_content=null;this.waiting=this.next_engine=!1};e.RenderContext.prototype=c.extend({},e.Object.prototype,{then:function(a){if(!g(a))if("string"===typeof a&&a in this.event_context)var b=this.event_context[a],a=function(a){return b.apply(this.event_context,[a])};else return this;var d=this;this.waiting?this.callbacks.push(a):(this.wait(),f.setTimeout(function(){var b=
a.apply(d,[d.content,d.previous_content]);!1!==b&&d.next(b)},13));return this},wait:function(){this.waiting=!0},next:function(a){this.waiting=!1;"undefined"!==typeof a&&(this.previous_content=this.content,this.content=a);0<this.callbacks.length&&this.then(this.callbacks.shift())},load:function(a,b,d){var e=this;return this.then(function(){var h,k,f;g(b)?(d=b,b={}):b=c.extend({},b);d&&this.then(d);if("string"===typeof a){h=(f=a.match(/\.json$/)||b.json)&&!0===b.cache||!1!==b.cache;e.next_engine=e.event_context.engineFor(a);
delete b.cache;delete b.json;b.engine&&(e.next_engine=b.engine,delete b.engine);if(h&&(k=this.event_context.app.templateCache(a)))return k;this.wait();c.ajax(c.extend({url:a,data:{},dataType:f?"json":null,type:"get",success:function(b){h&&e.event_context.app.templateCache(a,b);e.next(b)}},b));return!1}if(a.nodeType)return a.innerHTML;if(a.selector)return e.next_engine=a.attr("data-engine"),!1===b.clone?a.remove()[0].innerHTML.toString():a[0].innerHTML.toString()})},render:function(a,b,d){if(g(a)&&
!b)return this.then(a);!b&&this.content&&(b=this.content);return this.load(a).interpolate(b,a).then(d)},partial:function(a,b){return this.render(a,b).swap()},send:function(){var a=this,b=m(arguments),d=b.shift();h(b[0])&&(b=b[0]);return this.then(function(){b.push(function(b){a.next(b)});a.wait();d.apply(d,b);return!1})},collect:function(a,b,d){var e=this,h=function(){g(a)&&(b=a,a=this.content);var d=[],h=!1;c.each(a,function(a,c){var g=b.apply(e,[a,c]);if(g.jquery&&g.length==1){g=g[0];h=true}d.push(g);
return g});return h?d:d.join("")};return d?h():this.then(h)},renderEach:function(a,b,d,e){h(b)&&(e=d,d=b,b=null);return this.load(a).then(function(g){var k=this;d||(d=h(this.previous_content)?this.previous_content:[]);if(e)c.each(d,function(d,c){var h={},f=this.next_engine||a;b?h[b]=c:h=c;e(c,k.event_context.interpolate(g,h,f))});else return this.collect(d,function(d,c){var e={},h=this.next_engine||a;b?e[b]=c:e=c;return this.event_context.interpolate(g,e,h)},true)})},interpolate:function(a,b,d){var c=
this;return this.then(function(e,h){!a&&h&&(a=h);this.next_engine&&(b=this.next_engine,this.next_engine=!1);var g=c.event_context.interpolate(e,a,b);return d?h+g:g})},swap:function(){return this.then(function(a){this.event_context.swap(a)}).trigger("changed",{})},appendTo:function(a){return this.then(function(b){c(a).append(b)}).trigger("changed",{})},prependTo:function(a){return this.then(function(b){c(a).prepend(b)}).trigger("changed",{})},replace:function(a){return this.then(function(b){c(a).html(b)}).trigger("changed",
{})},trigger:function(a,b){return this.then(function(d){"undefined"==typeof b&&(b={content:d});this.event_context.trigger(a,b)})}});e.EventContext=function(a,b,d,c,h){this.app=a;this.verb=b;this.path=d;this.params=new e.Object(c);this.target=h};e.EventContext.prototype=c.extend({},e.Object.prototype,{$element:function(){return this.app.$element(m(arguments).shift())},engineFor:function(a){var b;if(g(a))return a;a=(a||this.app.template_engine).toString();if(b=a.match(/\.([^\.]+)$/))a=b[1];return a&&
g(this[a])?this[a]:this.app.template_engine?this.engineFor(this.app.template_engine):function(a){return a}},interpolate:function(a,b,d){return this.engineFor(d).apply(this,[a,b])},render:function(a,b,d){return(new e.RenderContext(this)).render(a,b,d)},renderEach:function(a,b,d,c){return(new e.RenderContext(this)).renderEach(a,b,d,c)},load:function(a,b,d){return(new e.RenderContext(this)).load(a,b,d)},partial:function(a,b){return(new e.RenderContext(this)).partial(a,b)},send:function(){var a=new e.RenderContext(this);
return a.send.apply(a,arguments)},redirect:function(){var a;a=m(arguments);var b=this.app.getLocation();1<a.length?(a.unshift("/"),a=this.join.apply(this,a)):a=a[0];this.trigger("redirect",{to:a});this.app.last_location=[this.verb,this.path];this.app.setLocation(a);b==a&&this.app.trigger("location-changed")},trigger:function(a,b){"undefined"==typeof b&&(b={});b.context||(b.context=this);return this.app.trigger(a,b)},eventNamespace:function(){return this.app.eventNamespace()},swap:function(a){return this.app.swap(a)},
notFound:function(){return this.app.notFound(this.verb,this.path)},json:function(a){return c.parseJSON(a)},toString:function(){return"Sammy.EventContext: "+[this.verb,this.path,this.params].join(" ")}});c.sammy="object"===typeof f.Sammy?f.Sammy=c.extend(e,f.Sammy):f.Sammy=e})(jQuery,window);(function(){var c;if("object"===typeof window)c=window;else{if("object"!==typeof this)throw Error("Cannot find 'window' object or its equivalent.");c=this}c.Sammy||(c.Sammy={});c.Sammy.GoogleAnalytics=function(c,e){var n=e||window.pageTracker,l=true;this.helpers({noTrack:function(){l=false},track:function(c){if(typeof n!="undefined"&&l){this.log("tracking",c);n._trackPageview(c)}}});this.bind("event-context-after",function(){this.track(this.path);l=true})}})();/*

 RelativeHash module for Sammy.js. 

 Allows one to use relative hash references (i.e. "#../../zzzz/xxxx") in routing
 between Sammy-controlled pages, where if you start on one "referrer" hash, 
 (i.e. "#/aaaa/bbbb/cccc/dddd") the relative hash would be resolved against it
 (i.e. to result in "#/aaaa/zzzz/xxxx") before the route is processed by Sammy
 or bubbled up to the browser (window.location). Also resolves paths given to
 context.app.setLocation() method.

 Copyright (c) 2012 Daniel Dotsenko, Willow Systems Corporation (willow-systems.com)
*/
(function(){var c;if("object"===typeof window)c=window;else{if("object"!==typeof this)throw Error("Cannot find 'window' object or its equivalent.");c=this}c.Sammy||(c.Sammy={});(function(c,e){var n=function(c,e){var k=c.split("/");k.pop();for(var f=e.split("/"),j,o=0,l=f.length;o<l;o++){j=f[o];j===".."?k.length>1&&k.pop():j!=="."&&k.push(j)}return k.join("/")},l=function(c,e){return function(k){var k=k.currentTarget,f=c(k),j=f.prop?f.attr("href"):k.getAttribute("href"),l=j.split("/",1)[0];if(l===
e+"."||l===e+".."){l=(f.prop?f.prop("href"):f[0].href).split(j);if(l.length===2&&l[1]===""){j=n(window.location.hash,j.substr(e.length,j.length));if(f.prop){f.prop("href",l[0]+j);f.attr("href",j)}else{k.href=l[0]+j;k.setAttribute("href",j)}}}return true}},m=function(c,e,f){var n="SammyJS-RelativeHashPlugin-ForHash-"+f,j=c.data("events"),m=true;if(j&&j.click)for(var q in j.click)j.click.hasOwnProperty(q)&&j.click[q].namespace===n&&(m=false);if(m)if(c.on)c.on("click."+n,"a",l(e,f));else c.delegate("a",
"click."+n,l(e,f))};c.RelativeHash=function(g,h){if(typeof h!=="string")throw Error("hashPrefix is not defined. You must init this plug in with hash prefix string appropriate to your case. (examples: '#', '#!')");if(!g.setLocationFilter){if(!c.SetLocationFilter)throw Error("Sammy SelLocationFilter plugin is required for RelativeHash plugin to run.");g.use("SetLocationFilter")}g.setLocationFilter.add(function(c){var e=c.split("/",1)[0];if(e===h+"."||e===h+"..")c=n(window.location.hash,c.substr(h.length,
c.length));return c});m(g.$element(),e,h)}})(c.Sammy,c.jQuery)})();/*

 SetLocationFilter module for Sammy.js. 

 Allows to delegate path scrubbing and alteration filters management to Sammy. 
 The filters are automatically invoked context.app.setLocation(path). 
 The resulting path will be result of application of all of the filters.

 Copyright (c) 2012 Daniel Dotsenko, Willow Systems Corporation (willow-systems.com)
*/
(function(){var c;if("object"===typeof window)c=window;else{if("object"!==typeof this)throw Error("Cannot find 'window' object or its equivalent.");c=this}c.Sammy||(c.Sammy={});(function(c){var e=function(c){var e={};this.add=function(c){var g=[Date.now()+c.toString().substr(0,100),c];e[g[0]]=c;return g};this.remove=function(c){e[c[0]]===c[1]&&delete e[c[0]]};var f=function(){this.name="StopSetLocationEvent"};f.prototype=Error;var g=function(c){throw new f(c);};this.filter=function(h,f){typeof f!==
"object"&&(f={});try{for(var m in e)e.hasOwnProperty(m)&&(h=e[m].call(c,h,g));f.success=true}catch(j){if(j.name==="StopSetLocationEvent")f.success=false;else throw j;}return h}};c.SetLocationFilter=function(c){if(!c.setLocationFilter){c.setLocationFilter=new e(c);var f=c.setLocation;c.setLocation=function(c){var e={},h=Array.prototype.slice.call(arguments);h[0]=this.setLocationFilter.filter(c,e);return e.success?f.apply(this,h):false}}}})(c.Sammy)})();
